[General]
daemon=false
to_op=300000
to_cnx=300000
pidfile=<%= @localstatedir %>/conscience-<%= @num %>.pid

[Service]
namespace=<%= @options["ns"] %>
type=conscience
register=false

load_ns_info=false


[Server.conscience]
min_workers=30
min_spare_workers=30
max_spare_workers=100
max_workers=200

listen=<%= @options["ipaddr"] %>:<%= @options["port"] %>

plugins=conscience,stats,fallback,ping<% if @options["enable_plugin_spoolmess"] == "true" %>,spoolmess<% end %>

<% if @options["enable_plugin_spoolmess"] == "true" %>[Plugin.spoolmess]
path=<%= @prefix %>/<%= @lib %>/grid/alert_spoolmess.so
param_sopcode_prefix=<%= @options["sop_prefix"] ? @options["sop_prefix"] : 'MUT-GRD' %>
param_message_prefix=[~BCO]<%= @options["cob"] ? @options["cob"] : 'DEFAULT' %>[~ECO][~BCL]<%= @options["client"] ? @options["client"] : 'REDCURRANT' %>[~ECL]
param_mapping:default=7000
param_mapping:srv.threads=0399
param_mapping:conscience.rawx.score=0300
param_mapping:conscience.meta1.score=0301
param_mapping:conscience.meta2.score=0302
param_mapping:conscience.meta1.broken=0303
param_mapping:conscience.meta2.broken=0304
param_mapping:conscience.solr.score=0305

<% end %>
[Plugin.stats]
path=<%= @prefix %>/<%= @lib %>/grid/msg_stats.so

[Plugin.fallback]
path=<%= @prefix %>/<%= @lib %>/grid/msg_fallback.so

[Plugin.ping]
path=<%= @prefix %>/<%= @lib %>/grid/msg_ping.so

[Plugin.conscience]
path=<%= @prefix %>/<%= @lib %>/grid/msg_conscience.so
param_namespace=<%= @options["ns"] %>
param_chunk_size=<%= @options["chunk_size"] ? @options["chunk_size"] : '10485760' %>
param_score_timeout=300
<% if @options["meta0_url"] and @options["meta0_url"] != '' %>
param_meta0=<%= @options["meta0_url"] %>
<% end %>
param_serialize_srvinfo_cache=true
param_option.ns_status=<%= @options["state"] %>
param_option.automatic_open=true
param_option.meta2_max_versions=0
<% if @options["stgpol"] and @options["stgpol"] != '' %>
param_option.storage_policy=<%= @options["stgpol"] %>
<% else %>
param_option.storage_policy=NORMAL
<% end %>
<% if @options["m1update"] and @options["m1update"] != '' %>
param_option.service_update_policy.meta1=<%= @options["m1update"] %>
<% else %>
param_option.service_update_policy.meta1=meta2=NONE|1|0|tag.type=m2v2;solr=APPEND;redis=REPLACE;sqlx=APPEND|3;tsmx=KEEP
<% end%>
param_storage_conf=<%= @sysconfdir %>/conscience-<%= @num %>.storage
<% if @options["enable_worm"] == "true" %>param_option.worm=on
<% end %>
<% if @options["auto_container"] == "true" %>param_option.event_delay=30
param_option.FLATNS_hash_bitlength=17
param_option.FLATNS_hash_offset=0
param_option.FLATNS_hash_size=0

<% end %>
param_events=<%= @sysconfdir %>/conscience-<%= @num %>.events

<% if @options["vns"] and @options["vns"] != "" %>
param_option.vns_list=<%= @options["vns"] %>
<% end %>

<% if @options["vnsopt"] and @options["vnsopt"] != "" %>
<% (@options["vnsopt"]).each do |v| -%>
<% if v.is_a?(Hash) %>
<% if v['quota'] != '' %>
param_option.quota_<%= v['name'] %>=<%= v['quota'] %>
<% end %>
<% if v['stgpol'] != '' %>
param_option.<%= v['name'] %>_storage_policy=<%= v['stgpol'] %>
<%end %>
<% if v['m1update'] and v['m1update'] != '' %>
param_option.<%= v['name'] %>_service_update_policy.meta1=<%= v['m1update'] %>
<% end %>
<% end %>
<% end -%>
<% end %>

<% if @options["container_max_size"] and @options["container_max_size"] != "" %>
param_option.container_max_size=<%= @options["container_max_size"]%>
<% end %>

param_service.default.score_timeout=300
param_service.default.score_variation_bound=5
param_service.default.score_expr=100

param_service.meta1.score_timeout=300
param_service.meta1.score_variation_bound=5
param_service.meta1.score_expr=root(2,((num stat.cpu) * (num stat.req_idle)))

param_service.meta2.score_timeout=300
param_service.meta2.score_variation_bound=5
param_service.meta2.score_expr=((num stat.space)>=5) * root(3,((num stat.cpu)*(num stat.req_idle)*(num stat.space)))

param_service.rawx.score_timeout=300
param_service.rawx.score_variation_bound=5
param_service.rawx.score_expr=((num stat.space)>=3) * root(2,((num stat.cpu)*(num stat.space)))

param_service.solr.score_timeout=300
param_service.solr.score_variation_bound=5
param_service.solr.score_expr=((num stat.index_size)<=85899345920) * root(4,(num stat.cpu)*(num stat.space)*(num stat.space)*(num stat.space))

param_service.saver.score_timeout=300
param_service.saver.score_variation_bound=5
param_service.saver.score_expr=((10*(num stat.queue_size))>1) * ((num stat.thread_idle)>1) * ((num stat.cpu)>1) * root(4,((num stat.queue_size) * (num stat.thread_idle) * (num stat.cpu) * (num stat.fail_rate)))

param_service.tsmx.score_timeout=300
param_service.tsmx.score_variation_bound=5
param_service.tsmx.score_expr=((num stat.tsm_idle_tape)>5) * ((num stat.tsm_idle_db)>5) * ((num stat.tsm_idle_log)>5) * root(5,((num stat.tsm_idle_db) * (num stat.tsm_idle_log) * (num stat.tsm_idle_disk) * (num stat.tsm_idle_tape) * (num stat.cpu)))

param_service.redis.score_timeout=300
param_service.redis.score_variation_bound=5
param_service.redis.score_expr=(100-(((num stat.used_memory_rss) / 1900000000) * 100))

param_service.replicator.score_timeout=300
param_service.replicator.score_variation_bound=5
param_service.replicator.score_expr=(num stat.cpu)

param_service.rainx.score_timeout=300
param_service.rainx.score_variation_bound=5

param_service.sqlx.score_timeout=300
param_service.sqlx.score_variation_bound=5
param_service.sqlx.score_expr=((num stat.space)>=5) * root(3,((num stat.cpu)*(num stat.req_idle)*(num stat.space)))

param_service.solr4.score_timeout=300
param_service.solr4.score_variation_bound=5
#lock solr4 on 95% disk usage or 10K cores.
param_service.solr4.score_expr=((num stat.space)>=5) * ((num tag.nbcores)<10000) * root(5,(100 - ((num tag.nbcores)/100))* (100 - ((num tag.nbcores)/100))*  (num stat.cpu)*(num stat.space)*(num stat.space))

param_service.clamav.score_timeout=300
param_service.clamav.score_variation_bound=5
param_service.clamav.score_expr=((num stat.threads_max) - (num stat.threads_live))

param_service.transco.score_timeout=300
param_service.transco.score_variation_bound=5
#param_service.transco.score_expr=(num stat.cpu)
#param_service.transco.score_expr=99

param_service.glccm.score_timeout=300
param_service.glccm.score_variation_bound=5
param_service.glccm.score_expr=((num stat.space)>=5) * ((num stat.queue_size)<=30) * root(4,(1 + (500/((num stat.queue_size)+1)))*(num stat.cpu)*(num stat.cpu)*(num stat.cpu))

param_service.manifest.score_timeout=300
param_service.manifest.score_variation_bound=5
param_service.manifest.score_expr=100

param_service.pac.score_timeout=300
param_service.pac.score_variation_bound=5
param_service.pac.score_expr=100

param_service.token-management.score_timeout=300
param_service.token-management.score_variation_bound=5
param_service.token-management.score_expr=100

param_service.streaming.score_timeout=300
param_service.streaming.score_variation_bound=5
param_service.streaming.score_expr=100

param_service.xmlapi.score_timeout=300
param_service.xmlapi.score_variation_bound=5
param_service.xmlapi.score_expr=100
